events {}
http
{
    upstream frontend
    {
        server frontend-container:3000;
    }
    upstream user_management
    {
        server user-management-container:8000;
    }
    upstream chat_service
    {
        server chat-container:8001;
    }
    upstream game_service
    {
        server game-container:8002;
    }
    upstream tournaments_service
    {
        server tournaments-container:8003;
    }
    map $http_upgrade $connection_upgrade
    {
        default upgrade;
        '' close;
    }
    map $remote_addr $proxy_forwarded_elem
    {
        default "$proxy_add_x_forwarded_for";
    }
    server
    {
        listen 443 ssl;
        ssl_certificate /vault/domain.crt;
        ssl_certificate_key /vault/domain.key;
        ssl_protocols TLSv1.3 TLSv1.2;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_forwarded_elem;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Static files location for each service
        location ~ ^/static/(user_management|chat_service|game_service|tournaments_service)/
        {
            set $upstream "";
            if ($uri ~ "^/static/user_management/")
            {
                set $upstream "user_management";
            }
            if ($uri ~ "^/static/chat_service/")
            {
                set $upstream "chat_service";
            }
            if ($uri ~ "^/static/game_service/")
            {
                set $upstream "game_service";
            }
            if ($uri ~ "^/static/tournaments_service/")
            {
                set $upstream "tournaments_service";
            }
            proxy_pass http://$upstream;
        }

        location /static/admin/ {
            proxy_pass http://user_management/static/admin/;
        }

        location ~ ^/admin/(user_management|chat_service|game_service|tournaments_service)/
        {
            set $upstream "";
            if ($uri ~ "^/admin/user_management/")
            {
                set $upstream "user_management";
            }
            if ($uri ~ "^/admin/chat_service/")
            {
                set $upstream "chat_service";
            }
            if ($uri ~ "^/admin/game_service/")
            {
                set $upstream "game_service";
            }
            if ($uri ~ "^/admin/tournaments_service/")
            {
                set $upstream "tournaments_service";
            }
            # Rewrite the URL to remove /admin/<upstream> and append /admin
            rewrite ^/admin/(user_management|chat_service|game_service|tournaments_service)/(.*)$ /admin/$1/$2 break;
            proxy_pass http://$upstream;
        }

        location /
        {
            proxy_pass http://frontend;
        }

        location ~ ^/ws/(notifications|chat|game|tournaments)/
        {
            set $upstream "";
            if ($uri ~ "^/ws/notifications/")
            {
                set $upstream "user_management";
            }
            if ($uri ~ "^/ws/chat/")
            {
                set $upstream "chat_service";
            }
            if ($uri ~ "^/ws/game/")
            {
                set $upstream "game_service";
            }
            if ($uri ~ "^/ws/tournaments/")
            {
                set $upstream "tournaments_service";
            }
            proxy_pass http://$upstream;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        location ~ ^/api/(auth|chat|game|tournaments)/
        {
            set $upstream "";
            if ($uri ~ "^/api/auth/")
            {
                set $upstream "user_management";
            }
            if ($uri ~ "^/api/chat/")
            {
                set $upstream "chat_service";
            }
            if ($uri ~ "^/api/game/")
            {
                set $upstream "game_service";
            }
            if ($uri ~ "^/api/tournaments/")
            {
                set $upstream "tournaments_service";
            }
            proxy_pass http://$upstream;
        }
    }
}